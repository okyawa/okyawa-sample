'use strict';

/** @typedef { import('./types').DialogImageOptionType } DialogImageOptionType */
/** @typedef { import('./types').GroupImageType } GroupImageType */

/** ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã‚‹å ´åˆã«dialogè¦ç´ ã¸ä»˜ä¸ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹å */
const DIALOG_HAS_CAPTION_CLASS_NAME = 'has_caption';
/** ç”»åƒã‚’æ‹¡å¤§ä¸­ã®å ´åˆã«dialogè¦ç´ ã¸ä»˜ä¸ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹å */
const DIALOG_ZOOM_CLASS_NAME = 'zoom';
/** æ‹¡å¤§/ç¸®å°ãƒœã‚¿ãƒ³ãŒä¸è¦ãªå ´åˆã«dialogè¦ç´ ã¸ä»˜ä¸ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹å */
const DIALOG_ZOOM_DISABLED_CLASS_NAME = 'zoom_disabled';
/** ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ãŸéš›ã«dialogè¦ç´ ã¸ä»˜ä¸ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹å */
const DIALOG_CONTROLS_HIDDEN_CLASS_NAME = 'controls_hidden';
/** ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…ã«ç”»åƒã®å¹…ã¨é«˜ã•ã‚’è¡¨ç¤ºã™ã‚‹å ´åˆã«dialogè¦ç´ ã¸ä»˜ä¸ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹å */
const DIALOG_IMAGE_SIZE_ENABLED_CLASS_NAME = 'image_size_enabled';
/** ç”»åƒã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãŒæœ‰åŠ¹ãªå ´åˆã«dialogè¦ç´ ã¸ä»˜ä¸ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹å */
const DIALOG_GROUP_IMAGES_ENABLED = 'image_group_enabled';

/**
 * dialogè¦ç´ ã‚’ä½¿ã£ãŸç”»åƒæ‹¡å¤§
 */
class DialogImage {
  /**
   * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   * @param {DialogImageOptionType} config ã‚ªãƒ—ã‚·ãƒ§ãƒ³æŒ‡å®š
   */
  constructor(config) {
    /** @type {DialogImageOptionType} ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
    this.options = { ...this.defaults, ...config };

    // dialogè¦ç´ 
    const modalDialog = document.querySelector(`#${this.options.dialogId}`);
    const existsDialog = modalDialog !== null && modalDialog instanceof HTMLDialogElement;
    /** @type {HTMLDialogElement} ç”»åƒæ‹¡å¤§è¡¨ç¤ºã™ã‚‹dialogè¦ç´  */
    this.modalDialog = existsDialog
      ? modalDialog
      : createDialogImageElement(this.options);

    if (!existsDialog) {
      // æœ€åˆã«dialogè¦ç´ ã¸ã‚»ãƒƒãƒˆã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆæœŸåŒ–
      this.setupInitialEvent();
    }

    const imagePreviewElem = this.modalDialog.querySelector('.image_preview');
    if (!imagePreviewElem) {
      throw new Error('ERROR :: Not Found ".image_preview" element');
    }
    /** @type {HTMLElement} ç”»åƒã‚’å›²ã‚€æ è¦ç´  */
    this.imagePreviewElem = imagePreviewElem;

    /** @type {GroupImageType[]} ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®æƒ…å ± */
    this.groupImages = [];
  }

  /**
   * ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®åˆæœŸå€¤
   * @type {DialogImageOptionType}
   * @private
   */
  get defaults() {
    /** @type {DialogImageOptionType} */
    return {
      dialogId: 'dialog_image',
      openLink: '.popup_img',
      groupSelector: null,
      groupUrlAttr: 'href',
      groupCaptionAttr: 'data-caption',
      groupCaptionWrapSelector: null,
      groupCaptionElemSelector: null,
      prevButtonInnerHTML: '&lt;',
      prevButtonTitle: 'Previous',
      nextButtonTitle: 'Next',
      nextButtonInnerHTML: '&gt;',
      imageSizeVisible: false,
      zoomInButtonInnerHTML: 'ğŸ”',
      zoomInButtonTitle: 'Zoom in',
      zoomOutButtonInnerHTML: 'ğŸ”',
      zoomOutButtonTitle: 'Zoom out',
      closeButtonInnerHTML: 'x',
      closeButtonTitle: 'Close',
    };
  }

  /**
   * æŒ‡å®šã—ãŸãƒªãƒ³ã‚¯è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç”»åƒæ‹¡å¤§ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã‚ˆã†ã«åˆæœŸåŒ–
   */
  init() {
    // é–‹ããƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    this.setupOpenLink();
  }

  /**
   * ç›´æ¥ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
   * @param {{url: string, caption?: string}} param0
   */
  open({ url, caption = ''}) {
    // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®æƒ…å ±ã‚’åˆæœŸåŒ–
    this.setupGroupImages();
    // ç”»åƒé€ã‚Šãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–
    this.setupNextPrevButton();

    // æ‹¡å¤§ç”»åƒã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
    this.openImagePreviewDialog(url, caption).then(() => {});
  }

  /**
   * æœ€åˆã«dialogè¦ç´ ã¸ã‚»ãƒƒãƒˆã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆæœŸåŒ–
   * @private
   */
  setupInitialEvent() {
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®æ å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆ
    this.setupDialogOuterClose();
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹éš›ã«å®Ÿè¡Œã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
    this.setupDialogClose();
    // æ‹¡å¤§ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    this.setupZoomInButton();
    // ç¸®å°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    this.setupZoomOutButton();
  }

  /**
   * é–‹ããƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
   * @private
   */
  setupOpenLink() {
    if (!this.options.openLink) {
      return;
    }
    const openLinkElements = typeof this.options.openLink === 'string'
      ? document.querySelectorAll(this.options.openLink)
      : this.options.openLink;
    openLinkElements.forEach((linkElem) => {
      linkElem.addEventListener('click', (event) => {
        event.preventDefault();

        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§è¡¨ç¤ºã™ã‚‹ç”»åƒã®URLã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
        const targetElem = event.currentTarget;
        const url = targetElem.getAttribute('href');
        const caption = targetElem.dataset.caption ?? '';

        // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®æƒ…å ±ã‚’åˆæœŸåŒ–
        this.setupGroupImages();
        // ç”»åƒé€ã‚Šãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–
        this.setupNextPrevButton();

        // ç”»åƒæ‹¡å¤§è¡¨ç¤ºãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
        this.openImagePreviewDialog(url, caption).then(() => {});
      });
    });
  }

  /**
   * ç”»åƒæ‹¡å¤§è¡¨ç¤ºãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
   * @param {string} url ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®URL
   * @param {string} caption ç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
   * @private
   */
  async openImagePreviewDialog(url, caption) {
    // æ‹¡å¤§ç”»åƒã‚’ã‚»ãƒƒãƒˆ
    this.imagePreviewElem.innerHTML = `<img src="${url}" alt="" />`;
    // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
    this.setupCaptionView(caption);
    // è¡¨ç¤ºç”»åƒè‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆ
    this.setupImageClick();
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    this.addKeyboardEvent();
    // bodyè¦ç´ ã®dataå±æ€§ã«dialogè¦ç´ ã®IDã‚’ã‚»ãƒƒãƒˆ (â€»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆç”¨)
    document.body.dataset.dialogId = this.options.dialogId;
    // dialogè¦ç´ ã®é–‹ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã™ã¹ã¦çµ‚äº†ã™ã‚‹ã¾ã§å¾…ã¤
    await waitDialogAnimation(this.modalDialog);
    // dialogè¦ç´ ã‚’é–‹ã
    this.showModal();
    // è¡¨ç¤ºã™ã‚‹ç”»åƒã®å¹…ã¨é«˜ã•ã‚’å–å¾—
    const { width, height } = await readImageSize(url);
    // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ä¸‹éƒ¨ã«ç”»åƒã®å¹…ã¨é«˜ã•ã‚’è¡¨ç¤º
    this.setupImageSizeView(width, height);
    // è¡¨ç¤ºã™ã‚‹ç”»åƒã«æ‹¡å¤§ãƒœã‚¿ãƒ³ãŒå¿…è¦ã‹ã‚’åˆ¤å®š
    await this.setupDialogZoomVisible(url, width, height);
    // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã„ã‚‹ã¨ãã®å‰å¾Œã®ç”»åƒã‚’å…ˆèª­ã¿
    this.preloadPrevNextImages(url);
  }

  /**
   * ç”»åƒé€ã‚Šã§ç”»åƒã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
   * @param {string} url ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®URL
   * @param {string} caption ç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
   * @returns {Promise<void>}
   * @private
   */
  async changeImagePreview(url, caption) {
    // æ‹¡å¤§ç”»åƒã‚’ã‚»ãƒƒãƒˆ
    this.imagePreviewElem.innerHTML = `<img src="${url}" alt="" />`;
    // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
    this.setupCaptionView(caption);
    // è¡¨ç¤ºç”»åƒè‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆ
    this.setupImageClick();
    // è¡¨ç¤ºã™ã‚‹ç”»åƒã®å¹…ã¨é«˜ã•ã‚’å–å¾—
    const { width, height } = await readImageSize(url);
    // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ä¸‹éƒ¨ã«ç”»åƒã®å¹…ã¨é«˜ã•ã‚’è¡¨ç¤º
    this.setupImageSizeView(width, height);
    // è¡¨ç¤ºã™ã‚‹ç”»åƒã«æ‹¡å¤§ãƒœã‚¿ãƒ³ãŒå¿…è¦ã‹ã‚’åˆ¤å®š
    await this.setupDialogZoomVisible(url, width, height);
    // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã„ã‚‹ã¨ãã®å‰å¾Œã®ç”»åƒã‚’å…ˆèª­ã¿
    this.preloadPrevNextImages(url);
  }

  /**
   * ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã„ã‚‹ã¨ãã®å‰å¾Œã®ç”»åƒã‚’å…ˆèª­ã¿
   * @param {string} currentUrl ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒã®URL
   * @returns
   */
  preloadPrevNextImages(currentUrl) {
    if (this.groupImages.length === 0) {
      // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ç”»åƒãªã—
      return;
    }
    const urlList = this.groupImages.map((image) => image.url);
    const currentIndex = urlList.indexOf(currentUrl);
    if (this.groupImages[currentIndex - 1]) {
      // å‰ã®ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
      (new Image()).src = this.groupImages[currentIndex - 1].url;
    }
    if (this.groupImages[currentIndex + 1]) {
      // æ¬¡ã®ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
      (new Image()).src = this.groupImages[currentIndex + 1].url;
    }
  }

  /**
   * ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®æƒ…å ±ã‚’åˆæœŸåŒ–
   * @private
   */
  setupGroupImages() {
    if (!this.options.groupSelector) {
      // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–æŒ‡å®šãªã—
      return;
    }
    const groupElements = document.querySelectorAll(this.options.groupSelector);
    if (groupElements.length <= 1) {
      // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã§ä¸€è‡´ã™ã‚‹è¦ç´ ãªã—
      return;
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
    this.groupImages = Array.from(groupElements).map((elem) => {
      return {
        url: elem.getAttribute(this.options.groupUrlAttr) ?? '',
        caption: elem.getAttribute(this.options.groupCaptionAttr) ?? '',
      };
    });

    // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒåˆ¥ã®è¦ç´ ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (
      this.options.groupCaptionAttr
      && this.options.groupCaptionWrapSelector
      && this.options.groupCaptionElemSelector
    ) {
      this.groupImages = this.groupImages.map((item) => {
        const activeElem = document.querySelector(
          `${this.options.groupSelector}[${this.options.groupUrlAttr}="${item.url}"]`,
        );
        // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹è¦ç´ ã‹ã‚‰ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–ã‚Šå‡ºã™
        const captionElem = activeElem
          .closest(this.options.groupCaptionWrapSelector)
          ?.querySelector(this.options.groupCaptionElemSelector);
        let caption = '';
        if (captionElem) {
          if (this.options.groupCaptionAttr === 'value') {
            caption = captionElem.value;
          } else {
            caption = captionElem.getAttribute(this.options.groupCaptionAttr);
          }
        }
        return {
          url: item.url,
          caption: caption ?? '',
        };
      });
    }

    // æ ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚¯ãƒ©ã‚¹åã‚’ä»˜ä¸
    this.modalDialog.classList.add(DIALOG_GROUP_IMAGES_ENABLED);
  }

  /**
   * ç”»åƒé€ã‚Šãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–
   * @private
   */
  setupNextPrevButton() {
    // ç”»åƒé€ã‚Šãƒœã‚¿ãƒ³ã®æ è¦ç´ 
    const prevAreaElem = this.modalDialog.querySelector('.prev_button_area');
    const nextAreaElem = this.modalDialog.querySelector('.next_button_area');

    // ä¸€æ—¦ä¸­èº«ã‚’ã‚¯ãƒªã‚¢
    prevAreaElem.innerHTML = '';
    nextAreaElem.innerHTML = '';

    // å‰ã¸ãƒœã‚¿ãƒ³
    const prevButtonElem = this.createPrevButtonElement();
    // æ¬¡ã¸ãƒœã‚¿ãƒ³
    const nextButtonElem = this.createNextButtonElement();

    // DOMã«ç”Ÿæˆã—ãŸãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    prevAreaElem.appendChild(prevButtonElem);
    nextAreaElem.appendChild(nextButtonElem);
  }

  /**
   * å‰ã¸ãƒœã‚¿ãƒ³ã®è¦ç´ ã‚’ç”Ÿæˆ
   * @returns {HTMLButtonElement}
   * @private
   */
  createPrevButtonElement() {
    const prevButtonElem = document.createElement('button');
    prevButtonElem.type = 'button';
    prevButtonElem.classList.add('prev_button');
    prevButtonElem.title = this.options.prevButtonTitle;
    prevButtonElem.innerHTML = this.options.prevButtonInnerHTML;
    prevButtonElem.addEventListener('click', async () => {
      await this.switchImage('prev');
    });
    return prevButtonElem;
  }

  /**
   * å‰ã¸ãƒœã‚¿ãƒ³ã®è¦ç´ ã‚’ç”Ÿæˆ
   * @returns {HTMLButtonElement}
   * @private
   */
  createNextButtonElement() {
    const nextButtonElem = document.createElement('button');
    nextButtonElem.type = 'button';
    nextButtonElem.classList.add('next_button');
    nextButtonElem.title = this.options.nextButtonTitle;
    nextButtonElem.innerHTML = this.options.nextButtonInnerHTML;
    nextButtonElem.addEventListener('click', async () => {
      await this.switchImage('next');
    });
    return nextButtonElem;
  }

  /**
   * ç”»åƒã‚’é€ã‚Šã‚’å®Ÿè¡Œ
   * @param {'prev' | 'next'} direction ç”»åƒã‚’é€ã‚‹æ–¹å‘
   * @returns {Promise<GroupImageType | null>}
   * @private
   */
  async switchImage(direction) {
    if (this.modalDialog.classList.contains(DIALOG_ZOOM_CLASS_NAME)) {
      // ã‚ºãƒ¼ãƒ æ™‚ã¯ç”»åƒé€ã‚Šã—ãªã„
      return;
    }
    const imageData = this.readNextImageData(direction);
    if (imageData === null) {
      return;
    }
    await this.changeImagePreview(imageData.url, imageData.caption);
  }

  /**
   * ç”»åƒé€ã‚Šã§ç”»åƒã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
   * @param {'prev' | 'next'} direction ç”»åƒã‚’é€ã‚‹æ–¹å‘
   * @returns {GroupImageType | null}
   * @private
   */
  readNextImageData(direction) {
    // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒURL
    const currentUrl = this.imagePreviewElem.querySelector('img')?.getAttribute('src') ?? '';
    const currentIndex = this.groupImages.findIndex((image) => image.url === currentUrl);

    if (
      (direction === 'prev' && this.groupImages[currentIndex - 1] === undefined)
      || (direction === 'next' && this.groupImages[currentIndex + 1] === undefined)
    ) {
      // è¡¨ç¤ºã™ã‚‹ç”»åƒãªã—
      return null;
    }

    // æ¬¡ã«è¡¨ç¤ºã™ã‚‹ç”»åƒURL
    const url = direction === 'prev'
      ? this.groupImages[currentIndex - 1].url
      : this.groupImages[currentIndex + 1].url;
    // æ¬¡ã«è¡¨ç¤ºã™ã‚‹ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
    const caption = direction === 'prev'
      ? this.groupImages[currentIndex - 1].caption
      : this.groupImages[currentIndex + 1].caption;

    return { url, caption };
  }


  /**
   * ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæœŸåŒ–
   * @param {string} caption ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ
   * @private
   */
  setupCaptionView(caption) {
    const captionElem = this.modalDialog.querySelector('.image_caption');
    if (caption) {
      const divElem = document.createElement('div');
      divElem.classList.add('caption_text');
      divElem.textContent = caption;
      captionElem.innerHTML = divElem.outerHTML;
      this.modalDialog.classList.add(DIALOG_HAS_CAPTION_CLASS_NAME);
    } else {
      captionElem.innerHTML = '';
      this.modalDialog.classList.remove(DIALOG_HAS_CAPTION_CLASS_NAME);
    }
  }

  /**
   * ç”»åƒã®å¹…ã¨é«˜ã•ã®è¡¨ç¤ºã‚’åˆæœŸåŒ–
   * @param {number} width ç”»åƒã®å¹…
   * @param {number} height ç”»åƒã®é«˜ã•
   * @private
   */
  setupImageSizeView(width, height) {
    if (this.options.imageSizeVisible !== true) {
      return;
    }
    const imageSizeElem = this.modalDialog.querySelector('.image_size');

    const divElem = document.createElement('div');
    divElem.classList.add('image_size_text');
    divElem.textContent = `(${width}x${height})`;

    imageSizeElem.innerHTML = divElem.outerHTML;
    this.modalDialog.classList.add(DIALOG_IMAGE_SIZE_ENABLED_CLASS_NAME);
  }

  /**
   * è¡¨ç¤ºç”»åƒè‡ªä½“ã®ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆ
   * @private
   */
  setupImageClick() {
    const imgElem = this.modalDialog.querySelector('.image_preview img');
    imgElem?.addEventListener('click', () => {
      if (this.modalDialog.classList.contains(DIALOG_ZOOM_CLASS_NAME)) {
        // ã‚ºãƒ¼ãƒ ä¸­ã®å ´åˆã¯ç¸®å°è¡¨ç¤ºã«æˆ»ã™
        this.modalDialog.classList.remove(DIALOG_ZOOM_CLASS_NAME);
        return;
      }
      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      this.modalDialog.classList.toggle(DIALOG_CONTROLS_HIDDEN_CLASS_NAME);
    });
  }

  /**
   * dialogè¦ç´ ã‚’é–‹ã
   */
  showModal() {
    // dialogè¦ç´ ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»˜ä¸ã—ã¦ã„ãŸdisplayã®styleæŒ‡å®šã‚’å‰Šé™¤
    this.modalDialog.style.display = '';
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
    this.modalDialog.showModal();
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹éš›ã«ã€HTMLè¦ç´ (èƒŒæ™¯éƒ¨åˆ†)ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
    document.documentElement.style.overflow = 'hidden';
  }

  /**
   * è¡¨ç¤ºã™ã‚‹ç”»åƒã«æ‹¡å¤§ãƒœã‚¿ãƒ³ãŒå¿…è¦ã‹ã‚’åˆ¤å®š
   * @param {string} url ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®URL
   * @param {number} width ç”»åƒã®å¹…
   * @param {number} height ç”»åƒã®é«˜ã•
   * @private
   */
  async setupDialogZoomVisible(url, width, height) {
    const zoomEnabled = width > this.imagePreviewElem.clientWidth || height > this.imagePreviewElem.clientHeight;
    if (zoomEnabled) {
      this.modalDialog.classList.remove(DIALOG_ZOOM_DISABLED_CLASS_NAME);
    } else {
      this.modalDialog.classList.add(DIALOG_ZOOM_DISABLED_CLASS_NAME);
    }
  }

  /**
   * ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
   * @private
   */
  addKeyboardEvent() {
    if (this.groupImages.length === 0) {
      // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚’ä½¿ã£ã¦ã„ãªã„å ´åˆã¯ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²ã¯ä¸è¦
      return;
    }
    document.addEventListener('keydown', handleKeyboardEvent);
  }

  /**
   * ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
   * @private
   */
  removeKeyboardEvent() {
    document.removeEventListener('keydown', handleKeyboardEvent);
  }

  /**
   * ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®æ å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆ
   * @private
   */
  setupDialogOuterClose() {
    this.modalDialog.addEventListener('click', (event) => {
      if (event.target === event.currentTarget) {
        this.modalDialog.close();
      }
    });
  }

  /**
   * ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹éš›ã«å®Ÿè¡Œã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²
   * @private
   */
  setupDialogClose() {
    this.modalDialog.addEventListener('close', async (event) => {
      const dialog = event.currentTarget;
      if (!(dialog instanceof HTMLDialogElement)) {
        // dialogè¦ç´ ã§ã¯ãªã„å ´åˆã¯ä¸­æ–­
        return;
      }
      // dialogè¦ç´ ã®é–‰ã˜ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã™ã¹ã¦çµ‚äº†ã™ã‚‹ã¾ã§å¾…ã¤
      await waitDialogAnimation(dialog);
      // dialogè¦ç´ ã®styleæŒ‡å®šã§éè¡¨ç¤ºã«ã™ã‚‹
      dialog.style.display = 'none';
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
      this.removeKeyboardEvent();
      // bodyè¦ç´ ã®dataå±æ€§ã«dialogè¦ç´ ã®IDã‚’å‰Šé™¤
      delete document.body.dataset.dialogId;
      // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸç”»åƒã®æƒ…å ±ã‚’åˆæœŸåŒ–
      this.groupImages = [];
      // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨ã¦ã‚¯ãƒªã‚¢
      this.modalDialog.querySelector('.image_caption').innerHTML = '';
      this.modalDialog.querySelector('.image_size').innerHTML = '';
      // ç”»åƒé€ã‚Šãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢
      this.modalDialog.querySelector('.prev_button_area').innerHTML = '';
      this.modalDialog.querySelector('.next_button_area').innerHTML = '';
      // åˆ¤å®šç”¨ã«ä»˜ä¸ã—ãŸã‚¯ãƒ©ã‚¹åã‚’åˆæœŸåŒ–
      this.modalDialog.classList.remove(DIALOG_ZOOM_CLASS_NAME);
      this.modalDialog.classList.remove(DIALOG_ZOOM_DISABLED_CLASS_NAME);
      this.modalDialog.classList.remove(DIALOG_HAS_CAPTION_CLASS_NAME);
      this.modalDialog.classList.remove(DIALOG_CONTROLS_HIDDEN_CLASS_NAME);
      this.modalDialog.classList.remove(DIALOG_IMAGE_SIZE_ENABLED_CLASS_NAME);
      this.modalDialog.classList.remove(DIALOG_GROUP_IMAGES_ENABLED);
      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ããŸã‚ã«è¿½åŠ ã—ãŸã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤
      document.documentElement.style.overflow = '';
    });
  }

  /**
   * æ‹¡å¤§ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
   * @private
   */
  setupZoomInButton() {
    this.modalDialog.querySelector('.zoom_in_button')?.addEventListener('click', () => {
      this.modalDialog.classList.add(DIALOG_ZOOM_CLASS_NAME);
    });
  }

  /**
   * ç¸®å°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
   * @private
   */
  setupZoomOutButton() {
    this.modalDialog.querySelector('.zoom_out_button')?.addEventListener('click', () => {
      this.modalDialog.classList.remove(DIALOG_ZOOM_CLASS_NAME);
    });
  }
}

window.DialogImage = DialogImage;

/**
 * dialogè¦ç´ ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã™ã¹ã¦çµ‚äº†ã™ã‚‹ã®ã‚’å¾…ã¤é–¢æ•°
 * @type {HTMLDialogElement} dialog dialogè¦ç´ 
 * @returns {Promise<PromiseSettledResult<any>[]>}
 */
function waitDialogAnimation(dialog) {
  return Promise.allSettled(
    dialog.getAnimations()
      .map((animation) => animation.finished),
  );
}

/**
 * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
 * @param {string} url ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®URL
 * @private
 */
async function readImageSize(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();

    img.onload = () => {
      const size = {
        width: img.naturalWidth,
        height: img.naturalHeight,
      };

      URL.revokeObjectURL(img.src);
      resolve(size);
    };

    img.onerror = (error) => {
      reject(error);
    };

    img.src = url;
  });
}

/**
 * æ–‡å­—åˆ—ã‚’HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
 * @param {string} value
 * @returns
 */
function htmlEscape(value) {
  return value
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

/**
 * ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 * @param {KeyboardEvent} event ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
 * @private
 */
function handleKeyboardEvent(event) {
  /** dialogè¦ç´ ã®idå€¤ */
  const dialogId = document.querySelector('body')?.dataset.dialogId;
  if (!dialogId) {
    return;
  }

  if (event.key === 'ArrowLeft') {
    // å³çŸ¢å°ããƒ¼: å‰ã¸
    const prevButtonElem = document.querySelector(`#${dialogId}`)
      ?.querySelector('dialog .prev_button');
    prevButtonElem?.dispatchEvent(new Event('click'));
    prevButtonElem?.focus();
    return;
  }

  if (event.key === 'ArrowRight') {
    // å³çŸ¢å°ã‚­ãƒ¼: æ¬¡ã¸
    const nextButtonElem = document.querySelector(`#${dialogId}`)
      ?.querySelector('dialog .next_button');
    nextButtonElem?.dispatchEvent(new Event('click'));
    nextButtonElem?.focus();
    return;
  }
}

/**
 * ç”»åƒæ‹¡å¤§ã«ä½¿ã†dialogè¦ç´ ã‚’ç”Ÿæˆ
 * @param {DialogImageOptionType} options
 * @returns
 */
function createDialogImageElement(options) {
  const modalDialog = document.querySelector(`#${options.dialogId}`);
  if (modalDialog !== null && modalDialog instanceof HTMLDialogElement) {
    // HTMLä¸Šã«è¦å®šã®dialogè¦ç´ ã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’ä½¿ã†
    return modalDialog;
  }

  // å¿…è¦ãªdialogè¦ç´ ã‚’ç”Ÿæˆ
  const dialogElem = document.createElement('dialog');
  dialogElem.id = options.dialogId;
  dialogElem.style.display = 'none';
  dialogElem.innerHTML = `
    <div class="image_preview_wrapper">
      <div class="preview_controls">
        <button
          type="button"
          class="zoom_in_button"
          title="${htmlEscape(options.zoomInButtonTitle)}"
        >
          ${options.zoomInButtonInnerHTML}
        </button>
        <button
          type="button"
          class="zoom_out_button"
          title="${htmlEscape(options.zoomOutButtonTitle)}"
        >
          ${options.zoomOutButtonInnerHTML}
        </button>
        <button
          type="button"
          class="close_button"
          title="${htmlEscape(options.closeButtonTitle)}"
          onclick="this.closest('dialog').close();"
        >
          ${options.closeButtonInnerHTML}
        </button>
      </div>
      <div class="image_main_area">
        <div class="prev_button_area"></div>
        <div class="image_preview"></div>
        <div class="next_button_area"></div>
      </div>
      <div class="image_caption"></div>
      <div class="image_size"></div>
    </div>
  `;

  // ç”Ÿæˆã—ãŸdialogè¦ç´ ã‚’bodyè¦ç´ ã®æœ«å°¾ã«è¿½åŠ 
  document.querySelector('body').appendChild(dialogElem);

  return dialogElem;
}
