<!DOCTYPE HTML>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>dialog要素 Sample</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="author" content="okyawa">
  <meta name="robots" content="noindex">
  <link rel="stylesheet" href="/res/css/neat.css">

  <style>

  </style>

</head>
<body>

  <header>
    <h1>dialog要素 Sample</h1>
  </header>

  <br />

  <section>
    <h2>dialog要素が提供するAPIと属性</h2>
    <ul>
      <li>ダイアログを表示するための <code>show()</code> メソッド</li>
      <li>
        モーダルダイアログを表示するための <code>showModal()</code> メソッド
        <ul>
          <li><code>showModal()</code> は、フォーカス制御などが含まれたモーダルダイアログ</li>
        </ul>
      </li>
      <li>
        ダイアログを閉じる <code>close()</code> メソッド
        <ul>
          <li><code>close()</code> メソッドでダイアログを閉じる際に引数として渡した値が格納される <code>returnValue</code> プロパティ</li>
        </ul>
      </li>
      <li>
        ダイアログの状態を表す <code>open</code> 属性
        <ul>
          <li>
            <code>open</code> 属性を直接触るのはNG
            <ul>
              <li>直接 <code>open</code> 属性を変更すると、 <code>close</code> イベントが発行されなかったり、エスケープキーでダイアログが閉じれなくなったり、 <code>showModal()</code> で背景部分が操作できないままになったり</li>
            </ul>
          </li>
          <li><code>show()</code> <code>showModal()</code> <code>close()</code> を使うことで、自動的に <code>open</code> 属性の付け外しが行われる</li>
        </ul>
      </li>
    </ul>
  </section>

  <section id="sample01">
    <fieldset>
      <legend>
        <h2><code>show()</code> メソッドでダイアログ表示</h2>
      </legend>
      <dialog></dialog>
      <button type="button" class="open_button">ダイアログを開く</button>
      <button type="button" class="close_button">ダイアログを閉じる</button>
      <dl>
        <dt>dialog要素から受け取った値:</dt>
        <dd><pre>　</pre></dd>
      </dl>
    </fieldset>
  </section>
  <script>
    const dialog01 = document.querySelector('#sample01 dialog');
    const openButton01 = document.querySelector('#sample01 button.open_button');
    const closeButton01 = document.querySelector('#sample01 button.close_button');
    const messageBox01 = document.querySelector('#sample01 dl dd pre');
    openButton01?.addEventListener('click', () => {
      dialog01.textContent = 'dialog要素のサンプルです。';
      // ダイアログを開く
      dialog01.show();
    });
    closeButton01?.addEventListener('click', () => {
      const message = `ダイアログを閉じました (${(new Date()).toISOString()})`;
      // ダイアログを閉じる
      dialog01.close(message);
      // ダイアログを閉じる際にセットした値を取得して表示
      messageBox01.textContent = dialog01.returnValue;
    });
  </script>

  <br />

  <section id="sample02">
    <fieldset>
      <legend>
        <h2><code>showModal()</code> メソッドでモーダルダイアログを表示</h2>
      </legend>
      <ul>
        <li>モーダルダイアログは、 <code>ESC</code> ボタンでも閉じることができる</li>
      </ul>
      <dialog>
        <p><code>showModal()</code> メソッドでモーダルダイアログです。</p>
        <br />
        <button
          type="button"
          onclick="this.closest('dialog').close(`閉じました (${(new Date()).toISOString()})`);"
        >
          閉じる
        </button>
      </dialog>
      <button type="button" class="open_button">ダイアログを開く</button>
      <dl>
        <dt>dialog要素から受け取った値:</dt>
        <dd><pre>　</pre></dd>
      </dl>
    </fieldset>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const modalDialog02 = document.querySelector('#sample02 dialog');
        const openButton02 = document.querySelector('#sample02 button.open_button');
        const messageBox02 = document.querySelector('#sample02 dl dd pre');
        // 開くボタンのイベント登録
        openButton02?.addEventListener('click', () => {
          // モーダルダイアログを開く
          modalDialog02?.showModal();
        });
        // 閉じる際に実行するイベントを登録
        modalDialog02?.addEventListener('close', (event) => {
          // 閉じた際に渡された値を画面に表示
          messageBox02.textContent = event.currentTarget?.returnValue;
        });
      })
    </script>
  </section>

  <br />

  <section id="sample03">
    <style>
      :root {
        --dialog-shadow: 0px 20px 36px 0px rgba(0, 0, 0, 0.6);
      }
      :where(#sample03, #sample04) dialog {
        box-shadow: var(--dialog-shadow);
      }
      :where(#sample03, #sample04) dialog::backdrop {
        backdrop-filter: blur(8px);
        /* Safariでbackdrop-filterを使用するにはベンダープレフィックスの指定が必要 */
        -webkit-backdrop-filter: blur(8px);
      }
    </style>
    <fieldset>
      <legend>
        <h2>モーダルダイアログと<code>form</code> 要素の <code>method="dialog"</code></h2>
      </legend>
      <ul>
        <li><code>dialog</code> 要素の <code>::backdrop</code> 疑似要素にstyle指定を当てることにより、背景部分にCSS指定を適用できる</li>
        <li>
          <code>form</code> 要素の <code>method="dialog"</code> を使用して、 ダイアログを閉じる際に値を受け取る
          <ul>
            <li><code>submit</code> 時にリクエストを送信せずにダイアログを閉じることができる</li>
            <li><code>button</code>要素など、 <code>submit</code> を指定した要素に <code>value</code> 属性がある場合は、その <code>value</code> 属性の値が <code>dialog</code> 要素の <code>returnValue</code> に渡される</li>
          </ul>
        </li>
      </ul>
      <dialog>
        <header style="position: relative;">
          <h3>Header</h3>
          <button
            class="close_button"
            type="button"
            title="Close"
            style="padding: 0 4px; position: absolute; top: 0; right: 0; border-radius: 50%;"
          >x</button>
        </header>
        <p>Message</p>
        <br />
        <form method="dialog">
          <button type="submit" value="ok">OK</button>
          <button type="submit" value="cancel">Cancel</button>
        </form>
      </dialog>
      <button type="button" class="open_button">ダイアログを開く</button>
      <dl>
        <dt>dialog要素から受け取った値:</dt>
        <dd><pre>　</pre></dd>
      </dl>
    </fieldset>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const modalDialog03 = document.querySelector('#sample03 dialog');
        const openButton03 = document.querySelector('#sample03 button.open_button');
        const closeButton03 = document.querySelector('#sample03 button.close_button');
        const messageBox03 = document.querySelector('#sample03 dl dd pre');
        if (!(modalDialog03 instanceof HTMLDialogElement)) {
          // dialog要素ではない場合は中断
          return;
        }
        // 開くボタンのイベント登録
        openButton03?.addEventListener('click', () => {
          // モーダルダイアログを開く
          modalDialog03.showModal();
          // モーダルダイアログを表示する際に、HTML要素(背景部分)がスクロールしないようにする
          document.documentElement.style.overflow = 'hidden';
        });
        // 閉じるボタンのイベント登録
        closeButton03?.addEventListener('click', (event) => {
          const dialog = event.currentTarget.closest('dialog');
          const message = `モーダルダイアログの閉じるボタンからを閉じました (${(new Date()).toISOString()})`;
          // モーダルダイアログを閉じる
          modalDialog03.close(message);
          // ダイアログを閉じる際にセットした値を取得して表示
          messageBox03.textContent = dialog.returnValue;
        });
        // 閉じる際に実行するイベントを登録
        modalDialog03.addEventListener('close', (event) => {
          // 背景スクロールを防ぐために追加したスタイルを削除
          document.documentElement.style.overflow = '';
          // 閉じた際に渡された値を画面に表示
          messageBox03.textContent = event.currentTarget?.returnValue;
        });
      })
    </script>
  </section>

  <br />

  <section id="sample04">
    <style> 
      @media (prefers-reduced-motion: no-preference) {
        /* フェード・インのアニメーション*/
        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }
        /* ズーム・インのアニメーション */
        @keyframes zoomIn {
          from {
            transform: scale(0.6);
          }
          to {
            transform: scale(1);
          }
        }
        /* open属性があるときに実行されるアニメーション (ダイアログを開くとき用) */
        #sample04 dialog[open] {
          /* @keyframesで作成したアニメーション名 */
          animation-name: fadeIn, zoomIn;
          /* アニメーションの進行状況 */
          animation-fill-mode: forwards;
          /* アニメーションの実行時間 */
          animation-duration: 200ms;
          /* アニメーションの進行状況 */
          animation-timing-function: ease-out;
        }
        /* フェード・アウトのアニメーション */
        @keyframes fadeOut {
          from {
            opacity: 1;
          }
          to {
            opacity: 0;
          }
        }
        /* ズーム・アウトのアニメーション */
        @keyframes zoomOut {
          from {
            transform: scale(1);
          }
          to {
            transform: scale(0.6);
          }
        }
        /* open属性がないときに実行されるアニメーション (ダイアログを閉じるとき用) */
        #sample04 dialog {
          animation-name: fadeOut, zoomOut;
          animation-fill-mode: forwards;
          animation-duration: 200ms;
          animation-timing-function: ease-out;
        }
      }
      #sample04 dialog {
        display: block;
        position: fixed;
        inset-inline: 0;
        inset-block: 0;
      }
    </style>
    <fieldset>
      <legend>
        <h2>ダイアログ表示時のアニメーション</h2>
      </legend>
      <dialog style="display: none;">
        <p>アニメーション付きのモーダルダイアログ</p>
        <br />
        <button
          type="button"
          onclick="this.closest('dialog').close(`閉じました (${(new Date()).toISOString()})`);"
        >
          閉じる
        </button>
      </dialog>
      <button type="button" class="open_button">ダイアログを開く</button>
      <dl>
        <dt>dialog要素から受け取った値:</dt>
        <dd><pre>　</pre></dd>
      </dl>
    </fieldset>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const modalDialog04 = document.querySelector('#sample04 dialog');
        const openButton04 = document.querySelector('#sample04 button.open_button');
        const messageBox04 = document.querySelector('#sample04 dl dd pre');
        if (!(modalDialog04 instanceof HTMLDialogElement)) {
          // dialog要素ではない場合は中断
          return;
        }
        // dialog要素のアニメーションがすべて終了するのを待つ関数
        const waitDialogAnimation = (dialog) => Promise.allSettled(
          dialog.getAnimations().map((animation) => animation.finished)
        );
        // 開くボタンのイベント登録
        openButton04?.addEventListener('click', async () => {
          // dialog要素の開くアニメーションがすべて終了するまで待つ
          await waitDialogAnimation(modalDialog04);
          // dialog要素にデフォルトで付与していたdisplayのstyle指定を削除
          modalDialog04.style.display = '';
          // モーダルダイアログを開く
          modalDialog04.showModal();
          // モーダルダイアログを表示する際に、HTML要素(背景部分)がスクロールしないようにする
          document.documentElement.style.overflow = 'hidden';
        });
        // 閉じる際に実行するイベントを登録
        modalDialog04.addEventListener('close', async (event) => {
          const dialog = event.currentTarget;
          if (!(dialog instanceof HTMLDialogElement)) {
            // dialog要素ではない場合は中断
            return;
          }
          // dialog要素の閉じるアニメーションがすべて終了するまで待つ
          await waitDialogAnimation(dialog);
          // dialog要素のstyle指定で非表示にする
          dialog.style.display = 'none';
          // 背景スクロールを防ぐために追加したスタイルを削除
          document.documentElement.style.overflow = '';
          // 閉じた際に渡された値を画面に表示
          messageBox04.textContent = dialog.returnValue;
        });
      })
    </script>
  </section>

</body>
</html>