<!DOCTYPE HTML>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>CSS Custom Highlight APIのSample</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="author" content="okyawa">
  <meta name="robots" content="noindex">
  <link rel="stylesheet" href="/res/css/neat.css">

  <style>
    /* ハイライトのスタイル指定 */
    ::highlight(search-results) {
      background-color: #f06;
      color: white;
    }
  </style>

  <script>
    /**
     * テキストのハイライトの初期化処理
     */
    function setupHighlight() {
      const query = document.getElementById('query');
      const article = document.querySelector('article');

      // 記事内のすべてのテキストノードを検索
      const treeWalker = document.createTreeWalker(article, NodeFilter.SHOW_TEXT);
      const allTextNodes = [];
      let currentNode = treeWalker.nextNode();
      while (treeWalker.nextNode()) {
        allTextNodes.push(treeWalker.currentNode);
      }

      // テキスト入力欄にイベントを登録
      query.addEventListener('input', () => {
        // CSS Custom Highlight API がサポートされているブラウザかどうかをチェック
        if (!CSS.highlights) {
          article.textContent = "ご利用中のブラウザは、CSS Custom Highlight APIがサポートされていません。";
          return;
        }

        // 前のハイライト状態をリセット
        CSS.highlights.clear();

        // 検索文字列を取得
        const str = query.value.trim().toLowerCase();
        if (!str) {
          return;
        }

        // すべてのテキストノードを反復処理し、一致するものを見つける
        const ranges = allTextNodes
          .map((el) => {
            return { el, text: el.textContent.toLowerCase()}
          })
          .map(({text, el}) => {
            const indices = [];
            let startPos = 0;
            while (startPos < text.length) {
              const index = text.indexOf(str, startPos);
              if (index === -1) break;
              indices.push(index);
              startPos = index + str.length;
            }

            // 検索対象文字列のインスタンスごとにrangeオブジェクトを作成
            return indices.map((index) => {
              const range = new Range();
              range.setStart(el, index);
              range.setEnd(el, index + str.length);
              return range;
            });
          });

        // 範囲のHighlightオブジェクトを生成
        const searchResultHighlight = new Highlight(...ranges.flat());

        // Highlightオブジェクトをレジストリに登録
        CSS.highlights.set('search-results', searchResultHighlight);
      });
    }

    window.addEventListener('DOMContentLoaded', setupHighlight);
  </script>

</head>
<body>

  <header>
    <h1>CSS Custom Highlight APIのSample</h1>
    <h2>テキストのハイライト表示</h2>
  </header>

  <br />

  <section>
    <h2>概要</h2>
    <ul>
      <li>JavaScriptを使用して範囲を作成し、CSS 使用してその範囲をスタイル設定することにより、ドキュメント上の任意のテキスト範囲をスタイル設定するメカニズム</li>
      <li><code>CSS Custom Highlight API</code>を使用すると、ページ内のDOM構造に影響を与えることなく、プログラムでテキスト範囲を作成し、それらをハイライトすることがでる</li>
    </ul>
  </section>

  <section>
    <h2>手順</h2>
    <ol>
      <li><code>Range</code>オブジェクトの作成</li>
      <li><code>Highlight</code>の範囲オブジェクトを作成</li>
      <li><code>HighlightRegistry</code>を使ってハイライトの登録</li>
      <li><code>::highlight</code>のCSS疑似要素を使って、ハイライトをスタイリング</li>
    </ol>
  </section>

  <br />
  <hr />
  <br />

  <section>
    <h2>ハイライトのサンプル</h2>
    <p>検索例: "<code>カクテル</code>"</p>
    <form>
      <fieldset>
        <label for="query">検索:</label>
        <input type="search" id="query" placeholder="検索文字列" />
      </fieldset>
    </form>
    <br />
    <article>
      <p>
        ゾンビカクテルは、3種類のラムの風味が重なり、とても爽やさがあって、フルーティでトロピカル感たっぷりの飲みやすさがあるものの、ロングカクテルでアルコール度数が高いため、飲みきったときの総アルコール量が多く、ちょっと危険なカクテル。映画「ティファニーで朝食を」のパーティーシーンでオードリーヘップバーンが飲んでいるカクテル。ゾンビカクテルの原型は、ドン・ビーチが1934年に経営するレストラン「ドン・ザ・ビーチコマー」のために作られた。ドンは商談の前に二日酔いを治す手助けを必要としていた男性のためにこのドリンクを作ったと言われている。この二日酔いの客は、数日後にドンのバーに戻ってきて、このドリンクのせいで旅行中ずっと「ゾンビ」になってしまったと不満を漏らしたという。ドン・ザ・ビーチコーマーは、このドリンクを提供している他の多くのバーやレストランとともに、客を一人2本までに制限しており、ドンは、その目を疑うようなアルコール度数のために、このドリンクが人を「歩く死者のように」することができると説明している。
      </p>
      <p>
        ミリオンダラーは、1894年、明治時代に横浜グランドホテルでイギリス人のルイス・エッピンガー (Louis Eppinger) により考案され、世界的に有名になったカクテル。口当たりは卵白の泡により、非常に滑らかでクリーミー。フルーティーさがあって、程良い甘みを感じる。当時はオールド・トム・ジンが使われていたが、近年はドライ・ジンが使用されている。横浜が発祥と言われる横浜4大カクテル、「ミリオン・ダラー」「ヨコハマ」「バンブー」「チェリーブロッサム」の一つ。
      </p>
      <p>
        ジンライムは、ライムの酸味とジンの風味を、そのままさっぱりと味わうことができるカクテル。カクテル言葉は「色あせぬ恋」。同じ材料でもシェイクするだけでギムレットというカクテルになる。甘いカクテルが苦手な方にはおすすめ。
      </p>
    </article>
  </section>

</body>
</html>